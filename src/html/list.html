<!DOCTYPE html>
<html>
<head>
    <meta content="application/xhtml+xml;charset=UTF-8" http-equiv="Content-Type">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <meta http-equiv="Cache" content="no-cache">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>MEE文件中心</title>
</head>
<body>
<div class="main">
    <div class="idx_title">
        <div style="display:inline-block;">
            <span style="font-weight:bold;font-size:24px;margin-right:32px;">目录: {{file_dir}} </span>
            <span style="font-size:16px;" title="上传文件至当前目录">
                <a href="javascript:void(0);" onclick="select_file();">上传</a>
                <a href="javascript:void(0);" onclick="create_dir();">创建目录</a>
            </span>
        </div>
    </div>
    <div class="idx_list">
        <div class="list_item list_bold">
            <div>&nbsp;&nbsp;</div>
            <div class="list_first">名称</div>
            <div class="list_second">日期</div>
            <div class="list_third">大小</div>
            <div>操作</div>
        </div>
        <div class="list_item">
            <div class="list_first"><a href="{{context_path}}/list?file_dir={{file_dir}}/..">上一级..</a></div>
        </div>
        {{#each file_list}}

        {{#if is_dir}}<!-- 目录 -->
        <div class="list_item" ondblclick="do_sel()">
            <div><input type="checkbox" name="sel" onclick="do_sel(this);"/></div>
            <div class="list_first">📁 <a href="{{../context_path}}/list?file_dir={{file_dir}}/{{file_name}}">{{file_name}}</a></div>
            <div class="list_second">{{date}} </div>
            <div class="list_third">{{file_size}} {{file_size_unit}}</div>
            <div><a href="javascript:void(0);" onclick="del(1,'{{file_dir}}/{{file_name}}');">删除</a></div>
        </div>
        {{else}}<!-- 文件 -->
        <div class="list_item">
            <div><input type="checkbox" name="sel" onclick="do_sel(this);"/></div>
            <div class="list_first">📄 <a href="{{../context_path}}/download?file_path={{file_dir}}/{{file_name}}" target="_blank">{{file_name}}</a></div>
            <div class="list_second">{{date}} </div>
            <div class="list_third">{{file_size}} {{file_size_unit}}</div>
            <div>
                <a href="javascript:void(0);" onclick="del(0,'{{file_dir}}/{{file_name}}');">删除</a>
                <a href="javascript:alert('开发中,敬请期待...');">预览</a>
            </div>

        </div>
        {{/if}}

        {{/each}}
    </div>
</div>

<!-- 上传文件:start -->
<div style="display:none;">
    <form method="POST" enctype="multipart/form-data">
        <!-- <input type="text" name="file_dir" class="form-control-file"  value="{{file_dir}}"/> -->
        <input type="file" name="files" class="form-control-file" required="required" multiple onchange="upload(this);"/>
    </form>
</div>
<!-- 上传文件:stop -->

</body>
<style>
    body{font-size:18px;top:0;left:0;}
    .main{width:84%;margin-left:8%;margin-top:2%;}
    .idx_title{color:#333;}
    .list_bold{font-weight:bold;font-size: 18px;}
    .list_item{margin:4px 8px;}
    .list_first{width:60%;display:inline-block;}
    .list_second{width:15%;display:inline-block;}
    .list_third{width:10%;display:inline-block;}
</style>
<script>
    // 上传选择文件
    function select_file(event){
        if(event){
            event.preventDefault();
        }
        document.querySelector("input[name=files]").click();
    }
    // 上传文件
    function upload(dom){
        // check
        // alert("upload=>"+dom.value);
        this.submit(dom.parentElement);
    }

    function submit(form){
        let header = {"enctype":"multipart/form-data","file_dir":"{{file_dir}}"};
        // 隐藏对话框
        fetch("upload", {method: 'POST', body: new FormData(form),headers:header})
            .then(response => response.json())
            .then(data =>
                function () {
                    if(!data || 1!=data.status){
                        alert(data.msg);
                        return;
                    }
                    alert(data.msg);
                    window.location.reload();
                }()
            )
            .catch(error => alert("上传超时,请刷新后重试:"+error)
            );
    }

    // 条目着色
    function do_sel(dom){
        if(dom.checked){
            dom.parentElement.style.backgroundColor='#ece6ee';
            dom.parentElement.style.fontWeight='bold';
            return;
        }
        dom.parentElement.style.backgroundColor='';
        dom.parentElement.style.fontWeight='normal';
    }

    // 删除
    function del(is_dir,del_path){
        // if (true){
        //     alert(is_dir+"||"+del_path);
        //     return;
        // }
        let formData = new FormData();
        formData.append("is_dir", is_dir);
        formData.append("del_path", del_path);
        fetch("delete",{ method: 'POST', body: formData })
            .then(response => response.json())
            .then(data =>
                function () {
                    if(!data || 1!=data.status){
                        alert(data.msg);
                        return;
                    }
                    alert(data.msg);
                    window.location.reload();
                }()
            )
            .catch(error => console.log("请求超时,请刷新后重试~")
            );
    }

    // 创建目录
    function create_dir(){
        // input
        let create_dir = prompt("这是一个输入对话框,请输入您的内容:","20");
        if (!create_dir){
            alert("您取消了输入~");
            return;
        }
        if(create_dir.startsWith(".") || create_dir.indexOf("/") || create_dir.indexOf("\\") || create_dir.indexOf("..")){
            alert("目录名非法[不可包含.\\/..]");
            return;
        }

        alert("您创建的目录是:"+create_dir);
        // submit
        let formData = new FormData();
        formData.append("file_dir", file_dir);
        formData.append("create_dir", create_dir);
        fetch("create_dir",{ method: 'POST', body: formData })
            .then(response => response.json())
            .then(data =>
                function () {
                    if(!data || 1!=data.status){
                        alert(data.msg);
                        return;
                    }
                    alert(data.msg);
                    window.location.reload();
                }()
            )
            .catch(error => console.log("异常,请刷新后重试:"+error)
            );
    }
</script>
</html>