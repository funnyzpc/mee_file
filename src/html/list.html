<!DOCTYPE html>
<html>
<head>
    <meta content="application/xhtml+xml;charset=UTF-8" http-equiv="Content-Type">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <meta http-equiv="Cache" content="no-cache">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>MEEæ–‡ä»¶ä¸­å¿ƒ</title>
</head>
<body>
<div class="main">
    <div class="idx_title">
        <div style="display:inline-block;">
            <span style="font-weight:bold;font-size:24px;margin-right:32px;">ç›®å½•: {{file_dir}} </span>
            <span style="font-size:16px;" title="ä¸Šä¼ æ–‡ä»¶è‡³å½“å‰ç›®å½•">
                <a href="javascript:void(0);" onclick="select_file();">ä¸Šä¼ </a>
                <a href="javascript:void(0);" onclick="create_dir();">åˆ›å»ºç›®å½•</a>
            </span>
        </div>
    </div>
    <div class="idx_list">
        <div class="list_item list_bold">
            <div>&nbsp;&nbsp;</div>
            <div class="list_first">åç§°</div>
            <div class="list_second">æ—¥æœŸ</div>
            <div class="list_third">å¤§å°</div>
            <div>æ“ä½œ</div>
        </div>
        <div class="list_item">
            <div class="list_first"><a href="{{context_path}}/list?file_dir={{file_dir}}/..">ä¸Šä¸€çº§..</a></div>
        </div>
        {{#each file_list}}

        {{#if is_dir}}<!-- ç›®å½• -->
        <div class="list_item" ondblclick="do_sel()">
            <div><input type="checkbox" name="sel" onclick="do_sel(this);"/></div>
            <div class="list_first">ğŸ“ <a href="{{../context_path}}/list?file_dir={{file_dir}}/{{file_name}}">{{file_name}}</a></div>
            <div class="list_second">{{date}} </div>
            <div class="list_third">{{file_size}} {{file_size_unit}}</div>
            <div><a href="javascript:void(0);" onclick="del(1,'{{file_dir}}/{{file_name}}');">åˆ é™¤</a></div>
        </div>
        {{else}}<!-- æ–‡ä»¶ -->
        <div class="list_item">
            <div><input type="checkbox" name="sel" onclick="do_sel(this);"/></div>
            <div class="list_first">ğŸ“„ <a href="{{../context_path}}/download?file_path={{file_dir}}/{{file_name}}" target="_blank">{{file_name}}</a></div>
            <div class="list_second">{{date}} </div>
            <div class="list_third">{{file_size}} {{file_size_unit}}</div>
            <div>
                <a href="javascript:void(0);" onclick="del(0,'{{file_dir}}/{{file_name}}');">åˆ é™¤</a>
                <a href="javascript:alert('å¼€å‘ä¸­,æ•¬è¯·æœŸå¾…...');">é¢„è§ˆ</a>
            </div>

        </div>
        {{/if}}

        {{/each}}
    </div>
</div>

<!-- ä¸Šä¼ æ–‡ä»¶:start -->
<div style="display:none;">
    <form method="POST" enctype="multipart/form-data">
        <!-- <input type="text" name="file_dir" class="form-control-file"  value="{{file_dir}}"/> -->
        <input type="file" name="files" class="form-control-file" required="required" multiple onchange="upload(this);"/>
    </form>
</div>
<!-- ä¸Šä¼ æ–‡ä»¶:stop -->

</body>
<style>
    body{font-size:18px;top:0;left:0;}
    .main{width:84%;margin-left:8%;margin-top:2%;}
    .idx_title{color:#333;}
    .list_bold{font-weight:bold;font-size: 18px;}
    .list_item{margin:4px 8px;}
    .list_first{width:60%;display:inline-block;}
    .list_second{width:15%;display:inline-block;}
    .list_third{width:10%;display:inline-block;}
</style>
<script>
    // ä¸Šä¼ é€‰æ‹©æ–‡ä»¶
    function select_file(event){
        if(event){
            event.preventDefault();
        }
        document.querySelector("input[name=files]").click();
    }
    // ä¸Šä¼ æ–‡ä»¶
    function upload(dom){
        // check
        // alert("upload=>"+dom.value);
        this.submit(dom.parentElement);
    }

    function submit(form){
        let header = {"enctype":"multipart/form-data","file_dir":"{{file_dir}}"};
        // éšè—å¯¹è¯æ¡†
        fetch("upload", {method: 'POST', body: new FormData(form),headers:header})
            .then(response => response.json())
            .then(data =>
                function () {
                    if(!data || 1!=data.status){
                        alert(data.msg);
                        return;
                    }
                    alert(data.msg);
                    window.location.reload();
                }()
            )
            .catch(error => alert("ä¸Šä¼ è¶…æ—¶,è¯·åˆ·æ–°åé‡è¯•:"+error)
            );
    }

    // æ¡ç›®ç€è‰²
    function do_sel(dom){
        if(dom.checked){
            dom.parentElement.style.backgroundColor='#ece6ee';
            dom.parentElement.style.fontWeight='bold';
            return;
        }
        dom.parentElement.style.backgroundColor='';
        dom.parentElement.style.fontWeight='normal';
    }

    // åˆ é™¤
    function del(is_dir,del_path){
        // if (true){
        //     alert(is_dir+"||"+del_path);
        //     return;
        // }
        let formData = new FormData();
        formData.append("is_dir", is_dir);
        formData.append("del_path", del_path);
        fetch("delete",{ method: 'POST', body: formData })
            .then(response => response.json())
            .then(data =>
                function () {
                    if(!data || 1!=data.status){
                        alert(data.msg);
                        return;
                    }
                    alert(data.msg);
                    window.location.reload();
                }()
            )
            .catch(error => console.log("è¯·æ±‚è¶…æ—¶,è¯·åˆ·æ–°åé‡è¯•~")
            );
    }

    // åˆ›å»ºç›®å½•
    function create_dir(){
        // input
        let create_dir = prompt("è¿™æ˜¯ä¸€ä¸ªè¾“å…¥å¯¹è¯æ¡†,è¯·è¾“å…¥æ‚¨çš„å†…å®¹:","20");
        if (!create_dir){
            alert("æ‚¨å–æ¶ˆäº†è¾“å…¥~");
            return;
        }
        if(create_dir.startsWith(".") || create_dir.indexOf("/") || create_dir.indexOf("\\") || create_dir.indexOf("..")){
            alert("ç›®å½•åéæ³•[ä¸å¯åŒ…å«.\\/..]");
            return;
        }

        alert("æ‚¨åˆ›å»ºçš„ç›®å½•æ˜¯:"+create_dir);
        // submit
        let formData = new FormData();
        formData.append("file_dir", file_dir);
        formData.append("create_dir", create_dir);
        fetch("create_dir",{ method: 'POST', body: formData })
            .then(response => response.json())
            .then(data =>
                function () {
                    if(!data || 1!=data.status){
                        alert(data.msg);
                        return;
                    }
                    alert(data.msg);
                    window.location.reload();
                }()
            )
            .catch(error => console.log("å¼‚å¸¸,è¯·åˆ·æ–°åé‡è¯•:"+error)
            );
    }
</script>
</html>